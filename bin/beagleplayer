#!/usr/bin/env python2.6

import os,sys
import asyncore
import time

id = os.getenv('BPL_ID')
if id is None:
    print "Beagleplayer ID not set (BPL_ID)"
    sys.exit(1)
   
bplLib = os.getenv('BPL_LIBDIR')
if bplLib is None:
    print "Beagleplayer libdir not set (BPL_LIBDIR)"
    sys.exit(1)
sys.path.append(bplLib)

loop = os.getenv('BPL_LOOP')
if loop is not None and loop == '1':
    loop = True
else:
    loop = False

import Beagleplayer
from Beagleplayer import *

def main():
    
    config = Beagleplayer.Config.PlayerConf();
    
    Beagleplayer.Server.becomeDaemon('.', ''.join(['/tmp/beagleplayer-', str(config.port), '.log']))
    Beagleplayer.Server.createPidfile(''.join(['/tmp/beagleplayer-', str(config.port), '.pid']))
    
    player = Beagleplayer.Player.Player(config.playlist, id)
    player.loop(loop)
    
    listener = Beagleplayer.Server.Listener(config, player, None, Message.PlayerMessage)
    
    while asyncore.socket_map:
        player.checkLoop()
        asyncore.loop(timeout=.5,count=1)
    
if __name__ == "__main__":
    main()
